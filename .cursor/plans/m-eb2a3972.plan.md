<!-- eb2a3972-8ec3-4359-9efa-d93b4d3357c2 9bd6eb72-44ba-4d1f-8a19-5d3e23e1f18d -->
# Plan d’installation MCP globale multi‑stack (sans GitLab)

### Objectifs

- Installation globale sous `~/mcp-server/` (Node-first) avec configs propres.
- Activer 5 serveurs essentiels: Postgres, GitHub, Filesystem, Docker, Next.js Devtools.
- Préparer des configs par projet pour: FastAPI+Next+Postgres, Django+React+Postgres, Symfony+Vue+MySQL.
- Sécurité: `.env` central, read-only par défaut, aucun secret en clair.

### 0) Prérequis système

**Obligatoire :**

- Node.js ≥ 18 (via nvm recommandé : `/home/deffice/.nvm/versions/node/v22.21.0/bin/npx`)
- npm, npx
- Python ≥ 3.10, uv/uvx (ou pipx)
- Docker Desktop/Engine (rootless ou avec accès socket `/var/run/docker.sock`)
- PostgreSQL client (`psql`), MySQL client (`mysql`) si MySQL utilisé

**Script de vérification complète (`~/mcp-server/bin/doctor.sh`) :**

```bash
#!/usr/bin/env bash
set -euo pipefail

echo "=== MCP System Doctor ==="
echo ""

# Node.js
echo -n "Node.js: "
if command -v node >/dev/null 2>&1; then
  node -v
else
  echo "❌ MANQUANT (requis ≥18)"
  exit 1
fi

# npm/npx
echo -n "npm: "
npm -v || echo "❌ MANQUANT"

echo -n "npx: "
npx --version || echo "❌ MANQUANT"

# Python
echo -n "Python: "
if command -v python3 >/dev/null 2>&1; then
  python3 --version
else
  echo "❌ MANQUANT (requis ≥3.10)"
  exit 1
fi

# Docker
echo -n "Docker: "
if command -v docker >/dev/null 2>&1; then
  docker --version
  echo -n "  Socket accessible: "
  if docker ps >/dev/null 2>&1; then
    echo "✅"
  else
    echo "❌ (permissions ou daemon off)"
  fi
else
  echo "❌ MANQUANT"
fi

# PostgreSQL client
echo -n "psql: "
psql --version 2>/dev/null || echo "⚠️  optionnel si Postgres utilisé"

# MySQL client
echo -n "mysql: "
mysql --version 2>/dev/null || echo "⚠️  optionnel si MySQL utilisé"

# Filesystem checks
echo ""
echo "Directories:"
echo "  ~/.cursor: $(test -d ~/.cursor && echo '✅' || echo '❌ manquant')"
echo "  ~/mcp-server: $(test -d ~/mcp-server && echo '✅' || echo '❌ manquant')"

echo ""
echo "=== Doctor check terminé ==="
```

### 1) Arborescence globale

```bash
mkdir -p ~/mcp-server/{bin,logs,servers,configs,examples}
mkdir -p ~/.cursor
```

### 2) Installation globale des serveurs (sans GitLab)

- Postgres MCP Pro (DB)
- GitHub (remote registry)
- Filesystem (roots contrôlés)
- Docker manager (container lifecycle)
- Next.js Devtools MCP (uniquement si projet Next.js)
- (Optionnels prêts: FastAPI-MCP, Neon)
```bash
# Postgres MCP Pro
npm_config_yes=true npx -y postgres-mcp --version || true

# GitHub MCP (remote)
npm_config_yes=true npx -y mcp-remote --help >/dev/null 2>&1 || true

# Filesystem server
npm_config_yes=true npx -y @modelcontextprotocol/server-filesystem --help >/dev/null 2>&1 || true

# Docker manager (image pull si nécessaire)
docker pull mcp/docker || true

# Next.js Devtools MCP
npm_config_yes=true npx -y next-devtools-mcp@latest --help >/dev/null 2>&1 || true

# Optionnels
pipx install fastapi-mcp || uv tool install fastapi-mcp || true
npm_config_yes=true npx -y @neondatabase/mcp-server-neon --help >/dev/null 2>&1 || true
```


### 3) Configuration globale Cursor `~/.cursor/mcp.json`

- Secrets via `~/.cursor/.env` (jamais en clair).
- Mode read-only par défaut pour Postgres/Filesystem.
```json
{
  "mcpServers": {
    "postgres-mcp": {
      "command": "npx",
      "args": ["-y", "postgres-mcp"],
      "env": {
        "PGHOST": "localhost",
        "PGPORT": "5432",
        "PGUSER": "${PGUSER}",
        "PGPASSWORD": "${PGPASSWORD}",
        "PGDATABASE": "${PGDATABASE}",
        "MCP_ALLOW_WRITE": "false",
        "LOG_LEVEL": "info"
      }
    },
    "github": {
      "command": "npx",
      "args": ["-y", "mcp-remote", "https://mcp.github.com"]
    },
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem", 
        "/home/$USER/projects", 
        "/home/$USER/scripts"
      ]
    },
    "docker": {
      "command": "docker",
      "args": [
        "run", "-i", "--rm",
        "-v", "/var/run/docker.sock:/var/run/docker.sock:ro",
        "-e", "DOCKER_HOST=unix:///var/run/docker.sock",
        "mcp/docker"
      ]
    },
    "next-devtools": {
      "command": "npx",
      "args": ["-y", "next-devtools-mcp@latest"]
    }
  }
}
```


`~/.cursor/.env` (exemple):

```bash
PGUSER=zartek
PGPASSWORD=changeme
PGDATABASE=dev_db
GITHUB_TOKEN=
```

### 4) Configs par projet (overlay via `.cursor/mcp.json`)

- Cursor fusionne `~/.cursor/mcp.json` + `./.cursor/mcp.json`.
- On n’ajoute que les spécificités du projet.

4.1) FastAPI + Next.js + Postgres

```bash
mkdir -p /path/projet-fastapi/.cursor
cat >/path/projet-fastapi/.cursor/mcp.json <<'JSON'
{
  "mcpServers": {
    "next-devtools": { "enabled": true },
    "postgres-mcp": {
      "env": { "PGDATABASE": "fastapi_db" }
    },
    "fastapi-mcp": {
      "command": "uvx",
      "args": ["fastapi-mcp", "run", "app.main:app"],
      "env": { "FASTAPI_MCP_PORT": "8080" }
    }
  }
}
JSON
```

4.2) Django + React + Postgres (pas de Next.js Devtools)

```bash
mkdir -p /path/projet-django/.cursor
cat >/path/projet-django/.cursor/mcp.json <<'JSON'
{
  "mcpServers": {
    "next-devtools": { "enabled": false },
    "postgres-mcp": {
      "env": { "PGDATABASE": "django_db" }
    }
  }
}
JSON
```

4.3) Symfony + Vue + MySQL

```bash
mkdir -p /path/projet-symfony/.cursor
cat >/path/projet-symfony/.cursor/mcp.json <<'JSON'
{
  "mcpServers": {
    "next-devtools": { "enabled": false },
    "mysql": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-mysql"],
      "env": {
        "MYSQL_HOST": "localhost",
        "MYSQL_PORT": "3306",
        "MYSQL_USER": "${MYSQL_USER}",
        "MYSQL_PASSWORD": "${MYSQL_PASSWORD}",
        "MYSQL_DATABASE": "symfony_db"
      }
    }
  }
}
JSON
```

### 5) Vérifications

- Redémarrer Cursor → MCP Settings → icônes vertes.
- Prompts de test:
```text
"Liste les tables de ma base Postgres courante"
"Parcours /home/$USER/projects et cherche 'TODO' en .py"
"Affiche les conteneurs Docker en cours"
"(Projet Next) Affiche les erreurs runtime Next.js"
```


### 6) Scripts de maintenance (~/mcp-server/bin)

- `install.sh`: installe/maj tous les serveurs
- `doctor.sh`: diagnostics (versions, sockets, ports)
- `update.sh`: met à jour @latest (dev) ou versions fixées (prod)

Esquisse:

```bash
cat >~/mcp-server/bin/install.sh <<'SH'
#!/usr/	bin/env bash
set -euo pipefail
npm_config_yes=true npx -y postgres-mcp --version || true
npm_config_yes=true npx -y mcp-remote --help || true
npm_config_yes=true npx -y @modelcontextprotocol/server-filesystem --help || true
docker pull mcp/docker || true
npm_config_yes=true npx -y next-devtools-mcp@latest --help || true
SH
chmod +x ~/mcp-server/bin/install.sh
```

### 7) Sécurité & bonnes pratiques

- `.env` uniquement, jamais de secret en clair.
- `MCP_ALLOW_WRITE=false` par défaut; activer ponctuellement.
- Limiter les roots du Filesystem aux dossiers nécessaires.
- Journalisation JSON côté serveurs sensibles.

### 8) Upgrade/rollback

- Dev: `@latest` pour expérimenter, Prod: pinner les versions.
- Tester en projet de staging avant de propager.

### To-dos

- [ ] Créer ~/.cursor/mcp.json global (GitHub, Filesystem, Docker) et ~/.cursor/.env
- [ ] Démarrer Postgres 16 et MySQL 8 en containers pour dev
- [ ] Configurer fastapi-next/.cursor/mcp.json (Postgres MCP, Next devtools)
- [ ] Configurer django-react/.cursor/mcp.json (Postgres MCP, GitLab MCP)
- [ ] Configurer symfony-vue/.cursor/mcp.json (GitLab MCP, DB accès via Docker/CLI)
- [ ] Appliquer read-only par défaut, limiter roots Filesystem, gérer secrets .env
- [ ] Valider outils: DB list tables, GitHub/GitLab action, Docker ps, FS search
- [ ] Ajouter .cursor/README.md par projet avec serveurs et variables requises